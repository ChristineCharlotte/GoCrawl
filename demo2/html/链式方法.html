<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">链式方法</h1>                                <a href="https://translate.gorm.io/project/go-gorm/zh-CN" target="_blank" rel="noopener" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>GORM 允许进行链式操作，所以您可以像这样写代码：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).First(&amp;user)</span><br></pre></td></tr></tbody></table></figure><p>GORM 中有三种类型的方法： <code>链式方法</code>、<code>Finisher 方法</code>、<code>新建会话方法</code></p><h2 id="链式方法" class="article-heading"><a href="#链式方法" class="headerlink" title="链式方法"></a>链式方法<a class="article-anchor" href="#链式方法" aria-hidden="true"></a></h2><p>链式方法是将 <code>Clauses</code> 修改或添加到当前 <code>Statement</code> 的方法，例如：</p><p><code>Where</code>、<code>Select</code>、<code>Omit</code>、<code>Joins</code>、<code>Scopes</code>、<code>Preload</code>、<code>Raw</code>（但在构建 SQL 语句时，<code>Raw</code> 不能与其它链式方法一起使用）…</p><p>这是 <a href="https://github.com/go-gorm/gorm/blob/master/chainable_api.go" target="_blank" rel="noopener">完整方法列表</a>，也可以查看 <a href="sql_builder.html">SQL 构建器</a> 获取更多关于 <code>Clauses</code> 的信息</p><h2 id="Finisher-方法" class="article-heading"><a href="#Finisher-方法" class="headerlink" title="Finisher 方法"></a><span id="finisher_method">Finisher 方法</span><a class="article-anchor" href="#Finisher-方法" aria-hidden="true"></a></h2><p>Finishers 是会立即执行注册回调的方法，然后生成并执行 SQL，比如这些方法：</p><p><code>Create</code>, <code>First</code>, <code>Find</code>, <code>Take</code>, <code>Save</code>, <code>Update</code>, <code>Delete</code>, <code>Scan</code>, <code>Row</code>, <code>Rows</code>…</p><p>查看<a href="https://github.com/go-gorm/gorm/blob/master/finisher_api.go" target="_blank" rel="noopener">完整方法列表</a></p><h2 id="新建会话模式" class="article-heading"><a href="#新建会话模式" class="headerlink" title="新建会话模式"></a>新建会话模式<a class="article-anchor" href="#新建会话模式" aria-hidden="true"></a></h2><p>在初始化了 <code>*gorm.DB</code> 或 <code>新建会话方法</code> 后， 调用下面的方法会创建一个新的 <code>Statement</code> 实例而不是使用当前的</p><p>GORM 定义了 <code>Session</code>、<code>WithContext</code>、<code>Debug</code> 方法做为 <code>新建会话方法</code>，查看<a href="session.html">会话</a> 获取详情.</p><p>让我们用一些例子来解释它：</p><p>示例 1：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"test.db"</span>), &amp;gorm.Config{})</span><br><span class="line"><span class="comment">// db 是一个刚完成初始化的 *gorm.DB 实例，其属于 `新建会话模式`</span></span><br><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `Where("name = ?", "jinzhu")` 是调用的第一个方法，它会创建一个新 `Statement`</span></span><br><span class="line"><span class="comment">// `Where("age = ?", 18)` 会复用 `Statement`，并将条件添加至这个 `Statement`</span></span><br><span class="line"><span class="comment">// `Find(&amp;users)` 是一个 finisher 方法，它运行注册的查询回调，生成并运行下面这条 SQL：</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 18;</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu2"</span>).Where(<span class="string">"age = ?"</span>, <span class="number">20</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `Where("name = ?", "jinzhu2")` 也是调用的第一个方法，也会创建一个新 `Statement`</span></span><br><span class="line"><span class="comment">// `Where("age = ?", 20)` 会复用 `Statement`，并将条件添加至这个 `Statement`</span></span><br><span class="line"><span class="comment">// `Find(&amp;users)` 是一个 finisher 方法，它运行注册的查询回调，生成并运行下面这条 SQL：</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu2' AND age = 20;</span></span><br><span class="line"></span><br><span class="line">db.Find(&amp;users)</span><br><span class="line"><span class="comment">// 对于这个 `新建会话模式` 的 `*gorm.DB` 实例来说，`Find(&amp;users)` 是一个 finisher 方法也是第一个调用的方法。 </span></span><br><span class="line"><span class="comment">// 它创建了一个新的 `Statement` 运行注册的查询回调，生成并运行下面这条 SQL：</span></span><br><span class="line"><span class="comment">// SELECT * FROM users;</span></span><br></pre></td></tr></tbody></table></figure><p>示例 2：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"test.db"</span>), &amp;gorm.Config{})</span><br><span class="line"><span class="comment">// db 是一个刚完成初始化的 *gorm.DB 实例，其属于 `新建会话模式`</span></span><br><span class="line">tx := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// `Where("name = ?", "jinzhu")` 是第一个被调用的方法，它创建了一个新的 `Statement` 并添加条件</span></span><br><span class="line"></span><br><span class="line">tx.Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `tx.Where("age = ?", 18)` 会复用上面的那个 `Statement`，并向其添加条件</span></span><br><span class="line"><span class="comment">// `Find(&amp;users)` 是一个 finisher 方法，它运行注册的查询回调，生成并运行下面这条 SQL：</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 18</span></span><br><span class="line"></span><br><span class="line">tx.Where(<span class="string">"age = ?"</span>, <span class="number">28</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `tx.Where("age = ?", 18)` 同样会复用上面的那个 `Statement`，并向其添加条件</span></span><br><span class="line"><span class="comment">// `Find(&amp;users)` 是一个 finisher 方法，它运行注册的查询回调，生成并运行下面这条 SQL：</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 18 AND age = 28;</span></span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>注意：</strong> 在示例 2 中，第一个查询会影响第二个查询生成的 SQL，因为 GORM 复用了 <code>Statement</code> 这可能会导致预期之外的问题，查看 <a href="#goroutine_safe">协程安全</a> 以避免该问题</p></blockquote><h2 id="方法链和协程安全" class="article-heading"><a href="#方法链和协程安全" class="headerlink" title="方法链和协程安全"></a><span id="goroutine_safe">方法链和协程安全</span><a class="article-anchor" href="#方法链和协程安全" aria-hidden="true"></a></h2><p>新初始化的 <code>*gorm.DB</code> 或调用 <code>新建会话方法</code> 后，GORM 会创建新的 <code>Statement</code> 实例。因此想要复用 <code>*gorm.DB</code>，您需要确保它们处于 <code>新建会话模式</code>，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"test.db"</span>), &amp;gorm.Config{})</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全的使用新初始化的 *gorm.DB</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">  <span class="keyword">go</span> db.Where(...).First(&amp;user)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">tx := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// 不安全的复用 Statement</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">  <span class="keyword">go</span> tx.Where(...).First(&amp;user)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">ctx, _ := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">ctxDB := db.WithContext(ctx)</span><br><span class="line"><span class="comment">// 在 `新建会话方法` 之后是安全的</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">  <span class="keyword">go</span> ctxDB.Where(...).First(&amp;user)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">ctx, _ := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">ctxDB := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).WithContext(ctx)</span><br><span class="line"><span class="comment">// 在 `新建会话方法` 之后是安全的</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">  <span class="keyword">go</span> ctxDB.Where(...).First(&amp;user) <span class="comment">// `name = 'jinzhu'` 会应用到查询中</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">tx := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Session(&amp;gorm.Session{})</span><br><span class="line"><span class="comment">// 在 `新建会话方法` 之后是安全的</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">  <span class="keyword">go</span> tx.Where(...).First(&amp;user) <span class="comment">// `name = 'jinzhu'` 会应用到查询中</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></body></html>              </div>